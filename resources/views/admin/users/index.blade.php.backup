@extends('layouts.admin')

@section('title', 'User Management')

@section('breadcrumbs')
<li class="breadcrumb-item active" aria-current="page">Users</li>
@endsection

@push('styles')
<style>
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .user-status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .user-actions {
        display: flex;
        gap: 0.5rem;
    }

    .last-login {
        font-size: 0.85rem;
        color: #6b7280;
    }

    .role-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }

    .filters-section {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }

    .search-filters {
        display: flex;
        gap: 1rem;
        align-items: end;
        flex-wrap: wrap;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    @media (max-width: 768px) {
        .search-filters {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group {
            min-width: auto;
        }

        .user-actions {
            flex-direction: column;
        }

        .table-responsive {
            font-size: 0.9rem;
        }
    }
</style>
@endpush

@section('content')
<div class="page-header">
    <h1 class="page-title">User Management</h1>
    <div class="page-actions">
        <a href="{{ url('/admin/users/create') }}" class="btn btn-primary">
            <i class="fas fa-user-plus me-2" aria-hidden="true"></i>Add New User
        </a>
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-download me-2" aria-hidden="true"></i>Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url('/admin/users/export?format=csv') }}">
                        <i class="fas fa-file-csv me-2" aria-hidden="true"></i>CSV
                    </a></li>
                <li><a class="dropdown-item" href="{{ url('/admin/users/export?format=excel') }}">
                        <i class="fas fa-file-excel me-2" aria-hidden="true"></i>Excel
                    </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- User Statistics -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">Total Users</span>
            <div class="stat-icon info">
                <i class="fas fa-users" aria-hidden="true"></i>
            </div>
        </div>
        <div class="stat-value">{{ $stats['total_users'] ?? '1,247' }}</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up" aria-hidden="true"></i>
            <span>+12 this week</span>
        </div>
    </div>

    <div class="stat-card success">
        <div class="stat-header">
            <span class="stat-title">Active Users</span>
            <div class="stat-icon success">
                <i class="fas fa-user-check" aria-hidden="true"></i>
            </div>
        </div>
        <div class="stat-value">{{ $stats['active_users'] ?? '1,189' }}</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up" aria-hidden="true"></i>
            <span>95.3% active</span>
        </div>
    </div>

    <div class="stat-card warning">
        <div class="stat-header">
            <span class="stat-title">Admins</span>
            <div class="stat-icon warning">
                <i class="fas fa-user-shield" aria-hidden="true"></i>
            </div>
        </div>
        <div class="stat-value">{{ $stats['admin_users'] ?? '8' }}</div>
        <div class="stat-change">
            <span>System administrators</span>
        </div>
    </div>

    <div class="stat-card danger">
        <div class="stat-header">
            <span class="stat-title">Registrations Today</span>
            <div class="stat-icon danger">
                <i class="fas fa-user-plus" aria-hidden="true"></i>
            </div>
        </div>
        <div class="stat-value">{{ $stats['new_users_today'] ?? '23' }}</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up" aria-hidden="true"></i>
            <span>+18% vs yesterday</span>
        </div>
    </div>
</div>

<!-- Filters Section -->
<div class="filters-section">
    <form method="GET" action="{{ url('/admin/users') }}">
        <div class="search-filters">
            <div class="filter-group">
                <label for="search" class="form-label">Search Users</label>
                <input type="text" id="search" name="search" class="form-control"
                    placeholder="Search by name, email..."
                    value="{{ request('search') }}">
            </div>

            <div class="filter-group">
                <label for="role" class="form-label">Role</label>
                <select id="role" name="role" class="form-select">
                    <option value="">All Roles</option>
                    <option value="admin" {{ request('role') == 'admin' ? 'selected' : '' }}>Admin</option>
                    <option value="speaker" {{ request('role') == 'speaker' ? 'selected' : '' }}>Speaker</option>
                    <option value="user" {{ request('role') == 'user' ? 'selected' : '' }}>User</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="status" class="form-label">Status</label>
                <select id="status" name="status" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="active" {{ request('status') == 'active' ? 'selected' : '' }}>Active</option>
                    <option value="inactive" {{ request('status') == 'inactive' ? 'selected' : '' }}>Inactive</option>
                    <option value="suspended" {{ request('status') == 'suspended' ? 'selected' : '' }}>Suspended</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="registration_date" class="form-label">Registration Date</label>
                <select id="registration_date" name="registration_date" class="form-select">
                    <option value="">All Time</option>
                    <option value="today" {{ request('registration_date') == 'today' ? 'selected' : '' }}>Today</option>
                    <option value="week" {{ request('registration_date') == 'week' ? 'selected' : '' }}>This Week</option>
                    <option value="month" {{ request('registration_date') == 'month' ? 'selected' : '' }}>This Month</option>
                </select>
            </div>

            <div class="filter-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search me-2" aria-hidden="true"></i>Filter
                </button>
                <a href="{{ url('/admin/users') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2" aria-hidden="true"></i>Clear
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Users Table -->
<div class="admin-card">
    <div class="admin-card-header">
        <h3 class="admin-card-title">
            All Users
            @if(isset($users))
            <span class="badge bg-secondary ms-2">{{ $users->total() ?? $users->count() }}</span>
            @endif
        </h3>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-danger" id="bulkDeleteBtn" style="display: none;">
                <i class="fas fa-trash me-1" aria-hidden="true"></i>Delete Selected
            </button>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Bulk Actions
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="bulkAction('activate')">
                            <i class="fas fa-check me-2" aria-hidden="true"></i>Activate
                        </a></li>
                    <li><a class="dropdown-item" href="#" onclick="bulkAction('deactivate')">
                            <i class="fas fa-ban me-2" aria-hidden="true"></i>Deactivate
                        </a></li>
                    <li><a class="dropdown-item" href="#" onclick="bulkAction('suspend')">
                            <i class="fas fa-pause me-2" aria-hidden="true"></i>Suspend
                        </a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="bulkAction('delete')">
                            <i class="fas fa-trash me-2" aria-hidden="true"></i>Delete
                        </a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="admin-card-body p-0">
        @if(isset($users) && $users->count() > 0)
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th>User</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Registrations</th>
                        <th>Last Login</th>
                        <th width="150" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach($users as $user)
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input user-checkbox" value="{{ $user->id }}">
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-3">
                                    @if($user->avatar)
                                    <img src="{{ asset('storage/' . $user->avatar) }}"
                                        alt="{{ $user->name }}" class="w-100 h-100 rounded-circle" style="object-fit: cover;">
                                    @else
                                    {{ strtoupper(substr($user->name, 0, 2)) }}
                                    @endif
                                </div>
                                <div>
                                    <h6 class="mb-0">{{ $user->name }}</h6>
                                    <small class="text-muted">{{ $user->email }}</small>
                                    @if($user->email_verified_at)
                                    <i class="fas fa-check-circle text-success ms-1" title="Email Verified" aria-hidden="true"></i>
                                    @else
                                    <i class="fas fa-exclamation-circle text-warning ms-1" title="Email Not Verified" aria-hidden="true"></i>
                                    @endif
                                </div>
                            </div>
                        </td>
                        <td>
                            @if($user->role)
                            @php
                            $roleColors = [
                            'admin' => 'danger',
                            'speaker' => 'primary',
                            'user' => 'secondary'
                            ];
                            $roleColor = $roleColors[$user->role->name] ?? 'secondary';
                            @endphp
                            <span class="badge bg-{{ $roleColor }} role-badge">
                                {{ ucfirst($user->role->name) }}
                            </span>
                            @else
                            <span class="badge bg-secondary role-badge">User</span>
                            @endif
                        </td>
                        <td>
                            @php
                            $status = $user->status ?? 'active';
                            $statusColors = [
                            'active' => 'success',
                            'inactive' => 'secondary',
                            'suspended' => 'danger'
                            ];
                            $statusColor = $statusColors[$status] ?? 'secondary';
                            @endphp
                            <span class="badge bg-{{ $statusColor }} user-status-badge">
                                {{ ucfirst($status) }}
                            </span>
                        </td>
                        <td>
                            <div class="text-center">
                                <div class="fw-semibold">{{ $user->registrations_count ?? 0 }}</div>
                                <small class="text-muted">events</small>
                            </div>
                        </td>
                        <td>
                            <div class="last-login">
                                @if($user->last_login_at)
                                {{ $user->last_login_at->diffForHumans() }}
                                @else
                                <span class="text-muted">Never</span>
                                @endif
                            </div>
                        </td>
                        <td class="text-end">
                            <div class="user-actions">
                                <a href="{{ url('/admin/users/' . $user->id) }}"
                                    class="btn btn-sm btn-outline-info" title="View User">
                                    <i class="fas fa-eye" aria-hidden="true"></i>
                                </a>
                                <a href="{{ url('/admin/users/' . $user->id . '/edit') }}"
                                    class="btn btn-sm btn-outline-primary" title="Edit User">
                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                </a>
                                @if($user->id !== auth()->id())
                                <button class="btn btn-sm btn-outline-danger"
                                    onclick="deleteUser({{ $user->id }}, '{{ addslashes($user->name) }}')"
                                    title="Delete User">
                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                </button>
                                @endif
                            </div>
                        </td>
                    </tr>
                    @endforeach
                </tbody>
            </table>
        </div>

        @if(method_exists($users, 'links'))
        <div class="d-flex justify-content-center p-3">
            {{ $users->links() }}
        </div>
        @endif
        @else
        <!-- Placeholder data when no users exist -->
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th>User</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Registrations</th>
                        <th>Last Login</th>
                        <th width="150" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="checkbox" class="form-check-input"></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-3">SA</div>
                                <div>
                                    <h6 class="mb-0">Sarah Anderson</h6>
                                    <small class="text-muted">sarah@example.com</small>
                                    <i class="fas fa-check-circle text-success ms-1" aria-hidden="true"></i>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-danger role-badge">Admin</span></td>
                        <td><span class="badge bg-success user-status-badge">Active</span></td>
                        <td>
                            <div class="text-center">
                                <div class="fw-semibold">5</div>
                                <small class="text-muted">events</small>
                            </div>
                        </td>
                        <td>
                            <div class="last-login">2 hours ago</div>
                        </td>
                        <td class="text-end">
                            <div class="user-actions">
                                <a href="#" class="btn btn-sm btn-outline-info" title="View User">
                                    <i class="fas fa-eye" aria-hidden="true"></i>
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-primary" title="Edit User">
                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" title="Delete User">
                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><input type="checkbox" class="form-check-input"></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-3">MC</div>
                                <div>
                                    <h6 class="mb-0">Michael Chen</h6>
                                    <small class="text-muted">michael@example.com</small>
                                    <i class="fas fa-check-circle text-success ms-1" aria-hidden="true"></i>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-primary role-badge">Speaker</span></td>
                        <td><span class="badge bg-success user-status-badge">Active</span></td>
                        <td>
                            <div class="text-center">
                                <div class="fw-semibold">3</div>
                                <small class="text-muted">events</small>
                            </div>
                        </td>
                        <td>
                            <div class="last-login">1 day ago</div>
                        </td>
                        <td class="text-end">
                            <div class="user-actions">
                                <a href="#" class="btn btn-sm btn-outline-info" title="View User">
                                    <i class="fas fa-eye" aria-hidden="true"></i>
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-primary" title="Edit User">
                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" title="Delete User">
                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        @endif
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the user "<span id="userName"></span>"?</p>
                <p class="text-danger small">This action cannot be undone and will also delete all associated registrations and data.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete User</button>
            </div>
        </div>
    </div>
</div>
@endsection

@push('scripts')
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Select all functionality
        const selectAll = document.getElementById('selectAll');
        const userCheckboxes = document.querySelectorAll('.user-checkbox');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

        selectAll?.addEventListener('change', function() {
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            toggleBulkActions();
        });

        userCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', toggleBulkActions);
        });

        function toggleBulkActions() {
            const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
            if (checkedBoxes.length > 0) {
                bulkDeleteBtn.style.display = 'block';
            } else {
                bulkDeleteBtn.style.display = 'none';
            }
        }

        // Delete user functionality
        let userToDelete = null;

        window.deleteUser = function(userId, userName) {
            userToDelete = userId;
            document.getElementById('userName').textContent = userName;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        };

        document.getElementById('confirmDelete')?.addEventListener('click', function() {
            if (userToDelete) {
                // Create form and submit
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/admin/users/${userToDelete}`;

                const methodField = document.createElement('input');
                methodField.type = 'hidden';
                methodField.name = '_method';
                methodField.value = 'DELETE';

                const tokenField = document.createElement('input');
                tokenField.type = 'hidden';
                tokenField.name = '_token';
                tokenField.value = document.querySelector('meta[name="csrf-token"]').content;

                form.appendChild(methodField);
                form.appendChild(tokenField);
                document.body.appendChild(form);
                form.submit();
            }
        });

        // Bulk actions
        window.bulkAction = function(action) {
            const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('Please select at least one user.');
                return;
            }

            const userIds = Array.from(checkedBoxes).map(cb => cb.value);

            if (action === 'delete') {
                if (confirm(`Are you sure you want to delete ${userIds.length} user(s)?`)) {
                    submitBulkAction('delete', userIds);
                }
            } else {
                submitBulkAction(action, userIds);
            }
        };

        function submitBulkAction(action, userIds) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/users/bulk-action';

            const tokenField = document.createElement('input');
            tokenField.type = 'hidden';
            tokenField.name = '_token';
            tokenField.value = document.querySelector('meta[name="csrf-token"]').content;

            const actionField = document.createElement('input');
            actionField.type = 'hidden';
            actionField.name = 'action';
            actionField.value = action;

            const idsField = document.createElement('input');
            idsField.type = 'hidden';
            idsField.name = 'user_ids';
            idsField.value = JSON.stringify(userIds);

            form.appendChild(tokenField);
            form.appendChild(actionField);
            form.appendChild(idsField);
            document.body.appendChild(form);
            form.submit();
        }
    });
</script>
@endpush